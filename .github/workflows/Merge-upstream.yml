name: Merge-upstream  

on:  
  push:  
    branches:  
      - lede  
      - test  
  schedule:  
    - cron: '0 */20 * * *'  # æ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡  
  workflow_dispatch: 
    inputs:
      ssh:
        description: 'ssh'
        required: false
        default: 'false'
  watch:  
    types: started  

jobs:  
  update-packages:  
    if: github.event.repository.owner.id == github.event.sender.id || ! github.event.sender.id  
    runs-on: ubuntu-latest  
    strategy:  
      matrix:  
        branch: [lede, test]  

    steps:  
      - name: Checkout  
        uses: actions/checkout@main  
        with:  
          ref: ${{ matrix.branch }}  

      - uses: de-vri-es/setup-git-credentials@main  
        with:  
          credentials: https://fuckactions:${{ secrets.REPO_TOKEN }}@github.com/  
    
      - name: Set git identity  
        run: |  
          git config --global user.email "github-actions[bot]@users.noreply.github.com"  
          git config --global user.name "github-actions[bot]"  
          sudo timedatectl set-timezone "Asia/Shanghai"  
    
      - name: Fetch Remote Changes  
        run: |  
          git fetch origin ${{ matrix.branch }}  
     
      - name: Sync upstream  
        run: |  
          shopt -s extglob  
          set +e  
          git rm -r --cache * >/dev/null 2>&1 &  
          rm -rf `find ./* -maxdepth 0 -type d` >/dev/null 2>&1  
          
          function git_clone() {  
            git clone --depth 1 $1 $2  
            if [ "$?" != 0 ]; then  
              echo "error on $1"  
              pid="$( ps -q $$ )"  
              kill $pid  
            fi  
          }  
          
          function git_sparse_clone() {  
            trap 'rm -rf "$tmpdir"' EXIT  
            branch="$1"; shift  
            curl="$1"; shift  
            rootdir="$PWD"  
            tmpdir="$(mktemp -d)" || exit 1  
            if [ ${#branch} -lt 10 ]; then  
              git clone -b "$branch" --depth 1 --filter=blob:none --sparse "$curl" "$tmpdir"  
              cd "$tmpdir"  
            else  
              git clone --filter=blob:none --sparse "$curl" "$tmpdir"  
              cd "$tmpdir"  
              git checkout "$branch"  
            fi  
            if [ "$?" != 0 ]; then  
              echo "error on $curl"  
              exit 1  
            fi  
            git sparse-checkout init --cone  
            git sparse-checkout set "$@"  
            mv -n $@ "$rootdir/" || true  
            cd "$rootdir"  
          }  
          
          function mvdir() {  
            mv -n `find $1/* -maxdepth 0 -type d` ./  
            rm -rf $1  
          }  
         
          # æ›´æ–° lede åˆ†æ”¯  
          if [ "${{ matrix.branch }}" == "lede" ]; then  
            echo 'æš‚æ— ' 
            git_clone https://github.com/tty228/luci-app-wechatpush wechatpush && mkdir luci-app-wechatpush && mv -n `find wechatpush/* -maxdepth 0` ./luci-app-wechatpush; rm -rf wechatpush  
            git_clone https://github.com/KFERMercer/luci-app-tcpdump tcpdump && mkdir luci-app-tcpdump && mv -n `find tcpdump/* -maxdepth 0` ./luci-app-tcpdump; rm -rf tcpdump   
            git_sparse_clone master "https://github.com/destan19/OpenAppFilter" luci-app-oaf open-app-filter oaf 
          
            git_clone https://github.com/jerrykuku/luci-theme-argon theme-argon && mkdir luci-theme-argon && mv -n `find theme-argon/* -maxdepth 0` ./luci-theme-argon; rm -rf theme-argon   
            git_clone https://github.com/jerrykuku/luci-app-argon-config argon-config && mkdir luci-app-argon-config && mv -n `find argon-config/* -maxdepth 0` ./luci-app-argon-config; rm -rf argon-config 
          
            git_clone https://github.com/sirpdboy/luci-app-eqosplus eqosplus && mkdir luci-app-eqosplus && mv -n `find eqosplus/* -maxdepth 0` ./luci-app-eqosplus; rm -rf eqosplus  
            git_clone https://github.com/sirpdboy/luci-theme-kucat theme-kucat && mkdir luci-theme-kucat && mv -n `find theme-kucat/* -maxdepth 0` ./luci-theme-kucat; rm -rf theme-kucat  
            git_clone https://github.com/sirpdboy/luci-app-kucat-config kucat-config && mkdir luci-app-kucat-config && mv -n `find kucat-config/* -maxdepth 0` ./luci-app-kucat-config; rm -rf kucat-config  
            git_clone https://github.com/sirpdboy/luci-app-parentcontrol parentcontrol && mkdir luci-app-parentcontrol && mv -n `find parentcontrol/* -maxdepth 0` ./luci-app-parentcontrol; rm -rf parentcontrol  
            git_sparse_clone master "https://github.com/sirpdboy/luci-app-netspeedtest" luci-app-netspeedtest homebox netspeedtest speedtest-cli  
            git_sparse_clone main "https://github.com/sirpdboy/luci-app-netwizard" luci-app-netwizard  
            git_sparse_clone main "https://github.com/sirpdboy/luci-app-timecontrol" luci-app-nft-timecontrol  
          
            git_clone https://github.com/xiaorouji/openwrt-passwall passwall && mv -n passwall/luci-app-passwall ./; rm -rf passwall  
            git_clone https://github.com/xiaorouji/openwrt-passwall2 passwall2 && mv -n passwall2/luci-app-passwall2 ./; rm -rf passwall2  
            git_clone https://github.com/xiaorouji/openwrt-passwall-packages passwaii && rm -rf passwaii/{geoview,.github} && mvdir passwaii  
            git_clone https://github.com/kenzok8/small && rm -rf small/{luci-app-passwall,luci-app-passwall2} && mvdir small  
            git_clone https://github.com/sbwml/packages_lang_golang.git lang && mkdir golang && mv -n `find lang/* -maxdepth 0` ./golang; rm -rf lang  
            git_clone https://github.com/pymumu/openwrt-smartdns && mkdir smartdns && mv -n `find openwrt-smartdns/* -maxdepth 0` ./smartdns; rm -rf openwrt-smartdns  
            git_clone https://github.com/pymumu/luci-app-smartdns smart && mkdir luci-app-smartdns && mv -n `find smart/* -maxdepth 0` ./luci-app-smartdns; rm -rf smart  
            git_sparse_clone main "https://github.com/Lienol/openwrt-package" luci-app-socat luci-app-control-weburl luci-app-control-webrestriction
            git_sparse_clone main "https://github.com/gdy666/luci-app-lucky" luci-app-lucky lucky  
          # æ›´æ–° openwrt åˆ†æ”¯  
          elif [ "${{ matrix.branch }}" == "test" ]; then  
            git_sparse_clone master "https://github.com/coolsnowwolf/lede" package/lean/default-settings  
          fi  
          
      - name: Language Management  
        run: |  
         if ls -d luci-app-*/po > /dev/null 2>&1; then  
           for dir in luci-app-*/po; do  
             ls -d "$dir"/*/ | grep -v '/zh-cn/' | grep -v '/zh_Hans/' | xargs rm -rf
           done
         fi   
         for I in $(find . -type d -name "zh-cn"); do  
           [ -d "${I/zh-cn/zh_Hans}" ] && continue  
           cp -rf "$I" "${I/zh-cn/zh_Hans}"  
         done  
         for I in $(find . -type d -name "zh_Hans"); do  
           [ -d "${I/zh_Hans/zh-cn}" ] && continue  
           cp -rf "$I" "${I/zh_Hans/zh-cn}"  
         done
     
      - name: Replace include in Makefile  
        run: |  
          replace_include() {  
              local filepath="$1"  
              if grep -q 'include ../../luci.mk' "$filepath"; then  
                  sed -i 's|include ../../luci.mk|include $(TOPDIR)/feeds/luci/luci.mk|' "$filepath"  
                  echo "Replaced in: $filepath"  
              fi  
          }  
          export -f replace_include  
          find . -name "Makefile" -exec bash -c 'replace_include "$0"' {} \;  
               
      - name: Apply Changes  
        run: |  
          Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ›¸" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")  
          git add .  
          git commit -m "${Emoji[$RANDOM % ${#Emoji[@]}]} Sync $(date +%Y-%m-%d" "%H:%M:%S)" || echo "No changes to commit"    
          git push -f
       
      - name: SSH connection to Actions
        uses: kiddin9/debugger-action@master
        if: github.event.inputs.ssh == 'true'
     
      - name: Delete workflow runs  
        uses: Mattraks/delete-workflow-runs@main  
        continue-on-error: true  
        with:  
          retain_days: 2  
          keep_minimum_runs: 4
